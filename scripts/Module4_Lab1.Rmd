---
title: 'Module "4": Lab 1'
author: "Ellen Bledsoe"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Species Richness and Diversity

Today, we will be working with community data to calculate species richness, plot species accumulation curves, and calculate two different of species diversity indices.

## Set-Up

For today's lab and assignment, we will need to load a new package called `vegan`. I've already installed the package on Posit Cloud, so we only need to load it into our work space. We are also going to load the `tidyverse`.

```{r}
library(vegan)
library(tidyverse)
```

The `vegan` package is one of the most popular packages available for working with community-level data. It includes functions for many multivariate analyses commonly used in the analysis of ecological communities. We will be using it today for its species accumulation curve functions.

## Species Accumulation Curves

For this example, we are going to use a dataset of fish abundances from the Doubs River in France. Each column represents a species, and each row is a survey.

```{r}
fish <- read_csv("../data_raw/Doubs_fish.csv")
head(fish)
```

First, we need to run our survey by species matrix through the `specaccum()` function to prepare the data to be put into a species accumulation curve model.

```{r}
fish_sac <- specaccum(fish)
```

Now, we want to put the object we just created, `fish_sac`, into the `fitspecaccum()` function. We need to specify the model we want as "asymp".

```{r}
fish_fit_sac <- fitspecaccum(fish_sac, model = "asymp")
```

Now that we've fit the model, we can get out the estimated asymptote of the species accumulation curve and plot the predicted curve.

`coef()` gives us the estimated asymptote of the species accumulation curve.

```{r}
coef(fish_fit_sac)
```

The asymptote is coming out right around 27, meaning that there are likely about 27 species in our community. If we look at the original data, we see that the data frame has 27 columns (AKA species), so we've probably caught all the species in the community.

Let's plot the data to see what it looks like.

```{r}
plot(fish_fit_sac)
```

Looks like we hit the asymptote well before we stopped sampling, which is a great sign.

## Species Diversity

Let's run through how we can calculate the Shannon and Simpson Diversity Indices for a community.

```{r}
# Don't worry about this code! 
# I'm making the frequencies of each fish species and making them into a dataframe
# The rownames are turned into a new column called "species"
abund <- as_tibble(fish_sac$freq, rownames = "species")
head(abund)
```

### Shannon Index

We'll start with the Shannon Index for the Doubs fish community.

Our first step is to sum up the total number of individuals in the community. We need this value to create the proportion for each species.

We will use the sum function and specify that we want to add up the numbers in the "value" column by using the dollar sign operator.

```{r}
N <- sum(abund$value)
N
```

Now we want to calculate the proportion of the population made up by each species. We will store these values by adding them into a new column in the `abund` data frame.

We do this by using the dollar sign operator again. On the left side of the assignment arrow, we create a new column. On the right side, we tell R what the new column should contain. In this case, we want to create the proportion for each species---the number of individuals per species divided by the total number of individuals in the population. We will call this new column `prop`.

```{r}
abund$prop <- abund$value / N
head(abund)
```

Note that we now a new column with all the proportions calculated. We want to continue this by taking the natural log of that proportion. We use the `log()` function to do that.

```{r}
abund$ln_prop <- log(abund$prop)
head(abund)
```

Now we need to multiple the values in the two columns we just created.

```{r}
abund$prop_x_lnprop <- abund$prop * abund$ln_prop
head(abund)
```

Finally, we can sum these values and multiple by -1 to calculate the Shannon Index (H) for this community.

```{r}
H = sum(abund$prop_x_lnprop) * -1
H
```

You will want to use a similar strategy to calculate the Simpson Index, as well.

### `tidyverse`

What would this look like in the `tidyverse`? If you're curious, here is the code below.

```{r}
H_tidy <- as_tibble(fish_sac$freq, rownames = "species") %>% 
  mutate(prop = value / N, # using the N already created
         ln_prop = log(prop),
         prop_x_lnprop = prop * ln_prop) %>% 
  summarise(H = sum(prop_x_lnprop) * -1)
```

The power of the `tidyverse` really shines when you have multiple communities for which you want to calculate values, such as the Shannon Index.

Take a look at this example:

```{r}
algar <- read.csv("../data_raw/algar_data.csv")
head(algar)
```

This dataset has 14 different species observed over 20 different communities. It would be very annoying to have to calculate 20 Shannon Indices using base R, the way we did above!

With `tidyverse`, we can calculate all of them at the same time.

First, we convert the data from a wide format (site x species) to a long format and remove any zeros (they cause NAs).

```{r}
algar_long <- algar %>% 
  rownames_to_column("site") %>% 
  pivot_longer(Alces.alces:Ursus.americanus,
               names_to = "species", values_to = "abundance") %>% 
  filter(abundance > 0)
head(algar_long)
```

From there, we create groups for each site then proceed with our calculations.

```{r}
H_indices <- algar_long %>% 
  group_by(Deployment.Location.ID) %>%            # group the data by site
  mutate(N = sum(abundance),    # calculate the total abunddance for each site
         prop = abundance / N,  # calculate the proportion of each species per site
         ln_prop = log(prop),
         prop_ln_prop = prop * ln_prop) %>% 
  summarise(H = sum(prop_ln_prop) * -1)
H_indices
```

Fun! And much faster :)
